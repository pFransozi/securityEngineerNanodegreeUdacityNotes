# Security Engineering Infrastructure Security

## Introduction

Infrastructure Security is a combination of a mindset and a skillset. Together they can help you secure, harden, and defend anything from the internet inwards.

Perimeter is the region that separates your organization from the Internet. The Internet is from where the attackers will come to poke around your perimeter's edge or even get in.

### Additional Resources

Wireshark - found at wireshark.org 
Nmap or Network Mapper - found at nmap.org 
CIS Benchmarks https://www.cisecurity.org/cis-benchmarks/

John The Ripper. Password Audit tool https://www.openwall.com/john/
Password Dump 7. By Tarasco Security https://www.tarasco.org/security/pwdump_7/ 
THC Hydra. Found at https://github.com/vanhauser-thc/thc-hydra

## Assessment introduction

### Key questions

What is the importance of knowing what assets we have in our infrastructure?
What system and third-party software are running in our assets?
How do we manage updates and security patching?

### how to approach Infrastructure Security

1. We have to identify the importance of Asset Management 
1. We have to mitigate the risks of Shadow IT 
1. We have to mitigate the risks of BYOD 
1. We have to perform Security Patching and Software Updates 
1. We have to identify CIS Benchmarks, Mitre CVE, Mitre ATT&CK 
1. We have to audit Physical & Software Assets 

* CIS Benchmarks: Industry security configuration best practices 
* CVE: Database of vulnerabilities 
* ATT&CK: Matrix of attack Tactics Technic and Procedures 
* OWASP: Top Web Vulnerabilities 

Infrastructure Security Goals: **We want to achieve visibility of all devices inside your  perimeter, enabling the defender to mitigate risks**; Identifying devices allows us to perform management, patching, and updates on discovered assets. **Especially be aware of IoTs**, which are increasingly joining the enterprise perimeter, which represents an augmentation of the attack surface.

### The Risk from IoTs

* IoT devices are hard to manage but easy to deploy. 
* Low-Quality Manufacturing & Software is vulnerable from the factory. 
* IoTs are very difficult to manage and update once deployed. For example, if you decide to place a camera on a far corner of your warehouse, these devices are usually forgotten, but they stay there, vulnerable and exposed. 
* Low in cost, but they can become very costly if exposed. These devices create an extended surface of attack.

**Remember Assets always need to be tracked**; 

### Assets types

* Permanent: They are likely to stay for a very long time. Examples of this are Servers, Desktops, Network Switches, Firewalls, WiFi Access Points 
* Temporary: They may stay for some time but not too long. E.g., phones that employees bring and connect into the perimeter WiFi, contractor workstations that are removed once their work is finished, laptops issued to contractors which are returned when work is completed 
* Transient: These are assets that are there for a specific amount of time. E.g., a vendor comes and joins your network for support or updates; a visitor connects to a company's guest WiFi, a customer comes for a meeting and connects to your conference room network drop.

**Asset management must also include remote connecting devices, like laptops or mobile devices.** When users go home, even though their devices are not on your company's property, technically speaking, they are part of your network. Some enterprises provide employees with security software and SOHO (Single Office/Home Office) security devices. This is done to mitigate potential risks that may be encountered at employee's homes.

### Components of a Perimeter

Perimeter: A network or networks that are separated from the internet. The following items are usually found in perimeters.
* Internet Gateways 
* Firewalls 
* Access Points 
* VPN Devices 
* Desktops 
* Servers 
* Mobiles 
* Access Points 

### Shadow IT & BYOD

This is a situation that occurs when **users bring their own devices to bypass security limitations and controls**. In some cases, shadow IT may increase productivity. For example, a security researcher may bring their own laptop to run malware sandboxes and software that is not allowed inside the perimeter. Despite such potential silver linings, generally, shadow IT is not something to leave alone - it needs to be controlled.

Mitigate Risks of Shadow IT
* Inventory all assets 
* Create access controls 
* Inventory all software, applications, and licenses 
* Implement security controls for users and remote access management 
* Train users in Acceptable Use of corporate devices and networks 
* Perform periodic network scans to discover new hosts (LAN/WIFI) 

**The Difference Between Shadow IT and BYOD**

Although Shadow IT and BYOD are used interchangeably, **Shadow IT is considered a risk and something that needs to be mitigated in corporate environments**. As its name implies, Shadow IT is not visible such as an employee bringing their own networking equipment into the office without permission or installing unauthorized software on their computer. All of these happen without consulting the IT department. On the other hand, **BYOD is a formal procedure to allow employees to use their own devices within the workplace**.

**A proper BYOD policy involves users or employees using their own devices in a controlled fashion, meaning compliance with the company's policies**.

**Steps to Mitigate Risks From BYOD**
* Supported devices must be monitored and protected (Example: Google Work Profile/ VMWare AirWatch). Both are agents that allow the management of devices and enforce the company's controls and security policies. 
* Ensure these devices are up to date by requiring BYOD devices to be set to update automatically. 
* You must provide applicable protections such as endpoint or antivirus for laptops, make sure software is licensed and operating systems and applications are up to date, and have security updates as well. 
* Prevent exfiltration
    * Protect Intellectual Property 
    * Implement data loss prevention procedures, harden and protect your most sensitive data 
    * Track data access 

**BYOD Policies**
* You must first craft a policy then enforce it. This policy must establish things like the brand of laptops, the hardware specs, the operating system software, and applications that must be running. 
* Protection and controls as explained prior (management agents, control checks). 
* A policy acknowledged by the user of what is acceptable and what is not. For example, you cannot browse adult sites. 
* Use Remote management as a way to access these devices remotely by authorized personnel. 
* A mechanism to isolate and remotely wipe the device; if it becomes infected, unusual activity is detected, or it is lost. For example, an employee from the sales department with customer sensitive data has resigned, and it is suspected they are going to work for a competitor. 
* Protect employee privacy. Whatever access is achieved in BYOD, you must respect and protect private and sensitive information. The privacy of employee pictures, text messages, and private life outside of work needs to be maintained.

## System and Third-Party Software Updates

### Why are software updates important?

The majority of low hanging fruit on the internet and inside the perimeter are usually internet hosts with outdated unpatched software. The updates are often released after disclosure, but many organizations neglect to complete them, leaving them vulnerable to attack promptly.

**It is important to establish procedures for software updates for all operating systems and inventoried applications**. Further, you must manage licenses and support contracts with vendors:
* Special licenses 
* Support contracts for End Of Life Operating System 
* Advanced release of updates 

**Software vendors usually announce their upcoming updates, and you should establish procedures to keep track of them**. CIS Benchmarks can be used for software updates guidance.

The exploitation of third-party software can take over the operating system. In many instances, the privileges of these applications are sufficient to take over OS. Any third party software must pass the security posture test. Any popular exploitable third-party software should be avoided if possible.

**Third-Party Update Pro Tips**
* **Must be supported by contracts and tracked**. 
    * Licensing and support contracts apply. You will have to call the third-party vendor about these. 
* **Vendors have their own schedules of releasing updates, and you have to keep track of it**. 
* **Third-Party software vulnerabilities can bypass your OS Defenses**. A clear example of this is Java. This leaves your systems open to severe attacks. Keep track of the highly vulnerable software you have to use.

Emergency software releases that are done outside of the normal schedules of releasing software and security updates and patches are referred to as out of band patches. Another consideration is having open-source elements in your assets. This might be a challenging situation, specifically if out of band patches are released, and the project is not keeping up with the urgency of exploits. However, choosing to use proprietary software can then lead to having to adapt project schedules and updates. Often, vendors have their own schedule for updates. Therefore, you need to be aware of their software update schedule. Here some examples below.

**Update Considerations**
* You should always test before passing the upgrade to all production systems. 
* Some updates are lengthy and require several reboots; make sure you plan for it. 
* Some updates can create more problems than fixes, be prepared to roll back or wait
    * Example: After an update, machines crashing or business essential applications failing are a good indication that you may have to roll back. 
* Modern hardware gets updated via the internet. Make sure to check the authenticity of these updates. 

**It is important to understand that you must update and secure the Operating System (OS) and the applications, frameworks, and plugins that run on it.**
For example:
* Java (**CVE-2019-2842**): Allows an attacker to takedown service s 
* Docker (**CVE-2019-15752**): Allows an attacker to Escalate Privileges and take over applications 
* Adobe Reader (**CVE-2018-4998**): Allows an attacker to crash services and possibly execute code via memory corruption 
* MS Office (**CVE-2019-1331**): Remote Code Evaluation (RCE) vulnerability in Microsoft Excel.Allows an attacker to execute code remotely in Excel. 
* **Remember that a CVE generally indicates that a vulnerability has been addressed by the program or company and can therefore be mitigated as in these examples above**.

**Software Inventory and Version Tracking**

Understand the importance of creating pre-configured, verified operating systems and software versions for deployment.
Software Inventory: The act of registering ALL the applications running in your perimeter hosts.
Software Packages: Software versions in use must be identified and added to your inventory tracking.

**It is essential to detect, identify, and register the software that you are running. Every Application must be inventoried, including their versions and patch levels, to create a baseline of your findings**.

### Implement Security Patching

Besides updating the operating system and applications software, you must update the security patches.

* **Security patching should be considered a single item apart from standard software updates**. 
* Many times, you will **have to apply a software update before a security update**. 

* **OOBP**, which means out of band patches: Emergency software releases that are done outside of the normal schedules of releasing software and security updates and patches are referred to as out of band patches. Extraordinarily dangerous and high-risk vulnerabilities affecting operating systems or applications. It May not be released during the ordinary schedules, although it may coincide with them. You must be on the lookout for these.

### What is a golden image?

**A representation of your organization approved, supported, and managed including operating systems, applications, or any other software that is deployed within your perimeter**. After you do your inventory of software and hardware, creating your company's baseline, you must decide what applications, operating systems, and hardware you want to procure for your users. **Every manifestation of this will be standard per segment** (i.e., Marketing, Sales, Accounting, etc.). This helps control inventory and management of assets and allows the implementation of a companies' security controls. These images are usually developed in consensus between IT Departments, Business Units, and the Security Department. Let's look at some examples. 

**Golden Images**
* Golden images only contain approved and licensed products, for example, Microsoft Outlook 2013 or Adobe Acrobat 10. 
* They must represent your security posture. 
* Must include all of the AV, Endpoint, Firewall, Security products applied to your machines. For example, a specific version of Carbon Black Endpoint. 
* It represents the company's infrastructure by segment (Business Units, IT, Security, Development).
    * Must be equal for everyone in their segment—only one image per department, desktop, or server.

### Mitigation Recommendation Reflection 2

You are assessing a newly acquired company and realize that some servers need to update a file sharing service for newer operating systems to have better compatibility. You perform a software integrity check and realize after doing some research in this update that there is a critical vulnerability associated with it. An upcoming update will address it. What should you do?

* Apply the update. Since this is inside the perimeter, there are zero risks of it being exploited.
    * This is the wrong course of action. Adding anything vulnerable to your perimeter only increases the chances of compromise. 
* Advise supervisor that due to the current state, this update cannot be applied as it will bring additional risk, then wait for the update and then apply it.
    * This is the correct mitigation recommendation. We need to be sure that we do not bring additional risk inside our perimeter. 

## Identify Industry Frameworks for Vulnerability Reference

### Mitre

1. Mitre (https://cve.mitre.org/) Common Vulnerabilities & Exposures: An industry database of vulnerabilities and exposures. 
2. Mitre Adversarial Tactics (https://attack.mitre.org/), Techniques & Common Knowledge: Known as Mitre ATT&CK a matrix of tactics, techniques & Procedures observed in malicious actors campaigns. 
3. Center for Internet Security Benchmarks (https://www.cisecurity.org/cis-benchmarks/): An organization that publishes best practices in security configuration and hardening of systems. 
4. OWASP TOP 10 (https://owasp.org/www-project-top-ten/): An open-source web applications security project. Top Ten Web vulnerabilities.

**Mitre Common Vulnerabilities & Exposures**: MITRE is a non-profit corporation that performs cybersecurity research for government agencies. They have created the most widely adopted  cybersecurity nomenclatures in the industry (CVE, ATT&CK).

What is MITRE CVE? An Industry Database of cybersecurity vulnerabilities. Remember how a CVE is composed:
* CVE - Common Vulnerability & Exposure 
* YEAR - Year it was issued 
* Number: The number it was assigned

**TTPS**: Tactics: A established behavior of an actor; Credential Access: malicious actors access a password; Techniques: The specific execution of that behavior; Brute Force SSH password: malicious actor uses thc hydra to brute-force ssh password; Procedures: How to perform the execution; Emotet a crimeware has been observed using a hardcoded list of passwords to brute force user accounts. 

**https://csrc.nist.gov/glossary/term/Tactics_Techniques_and_Procedures**


Mitre Adversarial Tactics, Techniques & Common Knowledge (https://www.mitre.org/publications/technical-papers/ttp-based-hunting)

We will focus on the enterprise version with eleven categories for techniques. 
* Initial Access: entry vectors to gain a foothold in newly compromised systems. 
* Execution: perform actions on compromised systems. 
* Persistence: maintain access in compromised systems. 
* Privilege Escalation: assume higher rights within compromised systems. 
* Defense Evasion: bypass controls inside the victim system. 
* Credential Access: obtain credentials from compromised systems. 
* Discovery: find new possible targets and data within compromised systems. 
* Lateral Movementt: move around compromised systems. 
* Collection: gather information elements from compromised systems. 
* Exfiltration: take data out of the targeted victim. 
* Impact: how it affects victim organization/environment.

**https://www.mitre.org/sites/default/files/publications/pr-19-3892-ttp-based-hunting.pdf**

Defenders and red teams often use Mitre Att&ck. Currently, there are several matrices:
* Enterprise 
* Mobile 
* Cloud pre-att&ck (https://attack.mitre.org/matrices/enterprise/cloud/)

### Open Web Application Security Project (OWASP)

Open Web Application Security Project (OWASP): A categorization of the top ten web vulnerabilities by a project that combines industry and community research.

**https://owasp.org/www-project-top-ten/**


### The flow of Infrastructure Security Assessment

* Discover
    * Use network tools to discover network assets 
    * Perform software inventory 
    * Register status of OS, updates, patches, security & third parties 
* Check
    * Perform network vulnerability scans (OpenVas, Nmap) 
    * Consult CIS Benchmarks, Mitre CVE/ATT&CK, OWASP 
* Apply
    * Software updates and patches 
    * Security updates 
    * Harden configuration 
    * Recommend/apply mitigation, decommission, or replacement of affected assets

## Access Management

### Access management is important because

* You need to protect highly sensitive data. Your private information and intellectual property need to be protected against unauthorized access. 
* You want to allow access to only those who need access. Not everyone needs internal or remote access to specific resources. 
* There is a need for a Firewall at every workstation and server. There should be access controls from remote access and internal access. Internal firewalls could be infiltrated. 
    * Let's say a malicious actor can penetrate the perimeter; adding additional protections may contain and prevent further lateral movement. 
* Web applications need to be protected, internally and externally. It would be best if you had a WAF (**Web Application Firewall**) to protect web applications. 
* Management of remote access protocols controls who can and who cannot access the perimeter remotely. 
* Specific networks within your perimeter need to be segmented and isolated for added protection. 
    * For example, product research and development network resources should not be visible to the sales department network.

Firewalls protect your perimeter from internet threats: There are always malicious actors scanning for vulnerable hosts. Even if you are sure your router or internet gateway is secure, it is always recommended to block unnecessary or potentially hostile traffic like pornography.

Furthermore, **your internal network may be compromised, and malicious actors may attempt to further move laterally inside your network**. Firewalls may provide additional protection against this type of scenario. Finally, firewalls can also be a preventive control against unnecessary access and traffic internally and externally.

### Access Control List - Computer File System

Depending on the operating system environments, these basic permissions can get more complicated and granular.
* The basic permissions of a file in a computer system are 
    * Read: You can only open a file and its contents. 
    * Write: You can write to a file and update its contents. 
    * Execute: You can open a file and execute code and os binaries against it. 
* Access Control Lists and Ownership Levels 
* Owner: Entity that owns the file. Sometimes the creator is the owner. Creators can read, write, and execute. 
* Group: The owner or Interacting entity on file may be part of a group with a set of permissions per their grouping. A group can have read-only, write, or execute privileges. 
* World: Anyone outside owner and groups. Permissions that apply to anyone or everyone.

Commands:
linux: ls -la file-name
windows: icacls file-name

You can build access control lists based on IP Addresses and Protocols. This can be done via switches, routers, or even firewalls. ACLs may perform some functions of a firewall device, but firewalls perform many more functions than simply blocking or segmenting a network. Also, Network ACLs can be applied internally or externally.

**Firewall Best Practices**

* Establish access based on the organization's needs and priorities. 
* Determine who can get access. 
* From where they can access. 
* What services and protocols are needed 
    * Example file sharing via SMB or internal company portals via HTTP. 
* Do you need VPN access (L2TP, IPSec, PPTP)? 
* Enforce services and protocols that are allowed or denied for inbound or outbound traffic 
* Application-aware. Take advantage of devices that have application-aware capabilities. 

Some firewalls have application monitoring capabilities so that operators can block the use of certain applications.
Social media applications (messaging, video chat) can provide access to external entities inside your perimeter, including targeted attacks against your users. **These attackers can then move laterally inside your perimeter**. 
You must consider if you want to allow or deny these applications inside your perimeter.

* Deny clear text protocols such as FTP, Telnet, and TFTP. 
* block things like SMTP, POP, if you don't have internal mail servers.
* There might be critical servers that require NO inbound traffic from the internet or specific departments. 
* Above all, your rules must cover the basics then apply specific business use-cases.

### Operating Systems Native Firewalls 

Linux: sudo ufw status
Windows: netsh advfirewall show allprofiles 

### Access Control List Best Practices
    
* Organizational Unit
    * Groups
        * Users
            * Directories and Files 

**You always start from the general to the specific**. **This is the best way to apply access control lists**.

### Example Implementing ACLs on a File

Let's say we have a File called xfile.txt, and its owner is user1. We want to give read access to user2 under the user context terminal in Ubuntu Linux.

setfacl -m:user2:r xfile.txt
getfacl xfile.txt

#### Best Practices for ACLS

* Avoid setting permissions for a single user. 
* Permissions should be targeted for only the users and groups that need access. 
* Avoid setting Everyone/World permissions whenever possible. 
* Always consider application access when setting ACLs. 
* Stringent permissions can break applications.
    * Avoid full control for users unless necessary. 
* Shares and directories should be owned by system/root/administrators, not users. 
* Remove Anonymous, GUEST, Everyone wherever you find it unless absolutely needed.

### Implementing VLANS and Network Segmentation

Network broadcast domains isolated in a computer network at layer 2 (Data Link). Defined under standard IEEE 802.1Q (https://grouper.ieee.org/groups/802/1/pages/802.1Q.html). VLANs are created and operated within an Ethernet network.

* **Isolate hosts within that defined VLAN**
* **Can improve performance by avoiding network segment collision**. 
* **Hosts can connect with each other even if not connected to the same switches**. 
* **There are hardware requirements to set up VLANs, and there might be an incompatibility between vendors**.
* **Management VLANs should be separated from all others**. **Isolate VLANs used for Guests /Visitors /Temporary personnel /Contractors**
* **Watch for promiscuous ports, unused interfaces, and disable unneeded protocols**.

* VLAN Vulnerabilities
    * VLAN Hopping Exploits: Jumping to different VLANs in an unauthorized manner. 
    * Switched Spoofing VLAN Attacks: Creates a fake switch and achieves a trunking link between VLANs. 

### Network Segmentation Best Practices

* Where applicable, use physical segmentation. 
    * The network segmentation concept is similar to VLANs but can be applied by other means. 
    * Example: Nuclear power plants cannot have ANYTHING connected to the internet. 
* Use firewalls to segment networks.
    * You can use Firewalls to segment your network and limit access from other network segments.
* Restrict access via routing and ACLs or VLANs.
* Visualize and map your most valued assets, make it difficult for attackers to get to them. 
* A well-segmented network may prevent and contain the damage from compromise. 

#### Think about: 
The security department receives complaints from employees in Accounting on the 4th floor that employees in Marketing on the 2nd floor are sending jobs to their printers and then walking up to pick them up. They worry that printouts left in output trays from the Accounting department may expose employees' sensitive data and company finances. 
You are tasked with preventing users in Marketing from sending print jobs to Accounting printers. How would you handle this situation?

One way out would be to create VLANs per department and establish restrictions per department VLAN for printers. By creating VLANs, the Marketing department will not be able to see any assets in the accounting department. Further, you may need to investigate why the marketing department is printing items on a different floor and try to help solve that issue. 


#### Think about: 

Your company provides free wifi for guests that come to visit the company. There are access points at the reception area where visitors can connect to the internet without any authentication. 
Recently, you received several alerts from your security monitoring software that users from the “GUEST” network were trying to access your file servers and internal web servers. 
What would you suggest to attempt to mitigate the risks from company visitors?

Creating a network segment that isolates the GUEST network from the company network would be the best option in this scenario. To protect company assets, employees, and IP, you must isolate the corporate network from the GUEST network.


### Identify Web Application Vulnerabilities

OWASP Top 10

### WAF To Protect Web Applications

**What is a Web Application Firewall?**
* Serves the same function of a firewall but focused on HTTP traffic, web services. 
* Protects against injection attacks (SQL Injection, NoSQL, OS, etc.). 
* Blocks known malicious requests and inputs 
    * Example: Format strings 
* Blocks or protects malicious API requests 

#### WAF Stateful vs. Stateless 

**Stateless**: Web Application Firewalls **that are based on static signatures**. For instance: a %27 (') within a URL request. If you see these types of requests, they should be blocked.

**Stateful**: **Looks beyond just a signature and finds patterns or heuristic-based on data to block attacks**. A Stateful WAF is the best choice. Example: IP Reputation is a database of known IP addresses used in past attacks. If Hex obfuscation is detected in traffic (737472696E67) in conjunction with IP reputation information block. In the second case, the addition of the IP reputation information makes the Stateful WAF more aware and able to mitigate more complex issues.

#### Open-Source WAFs

ModSecurity by TrustWave is the most popular open-source web application firewall and can be used with Linux based or Windows operating systems. ModSecurity has a plethora of community detection rules. This is definitely, the best choice if you are looking for an entry-level, low-cost implementation of a WAF. 

* ModSecurity has rules for attacks such as XSS SQL Injections, General Malicious activity & Common Attacks, and Trojans. 
* ModSecurity works with Microsoft IIS Server. 

### Apply MS Domain Isolation IPSec Policies

#### Active Directory

Microsoft Active Directory registers, maps, and resolves all components within a Microsoft Network domain and also Linux based components. Active Directory networks are the most popular choice for enterprise and medium-sized business networks. Therefore, you must become familiar with them in your career as a security professional.

**Active Directory has management tools for**:
* Network protocols 
* User authentication 
* Access management 
* Computers 
* Web servers and databases 
* Printers, etc.

When you have Active Directory networks, **you can apply network access management policies**. Some of the relevant policies for this lesson include:
* **Domain Isolation Policies** 
* **IP Security Policies**

#### Domain Isolation & IP Security Policies

You can implement Domain Isolation via several methods, including firewall profiles in your workstations. IPSecurity Policies are also a means of enforcing Domain Isolation.
* IP Security Policies apply security policies to network connections at the packet level 
* IP Security Policies are set on Domain Controllers via a rule schema format named Group Policies. 

Further research is recommended once you approach IPSecurity policies as a means of network segmentation or domain isolation:

* https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-firewall/domain-isolation-policy-design-example
* https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj721511(v=ws.11)
* https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/security-policy-settings

Group Policies: A feature within Active Directory Domains that controls users and computers' operating environments. Group Policies can be used to apply and enforce Network, User, Software policies. 

Examples of these are: 
* Installing a specific software package in an Organizational Unit like installing Adobe Photoshop for the marketing department. 
* Enforcing IPSec policies against specific organizational units. You might need to isolate a specific organizational unit like Accounting from seeing any shares, files, or hosts related to Research & Development.

#### Active Directory Weak Points

While Active Directory (AD) has many benefits, there are some weak points as well.
* **Domain Controllers are the Crown Jewels and be protected and secured**. **Once a domain controller has been compromised, an attacker can change all passwords, add new users, lock everyone out, etc.** 
* **DNS is the Achilles' heel of AD. If DNS doesn't work, everything will break**. 
* **If you apply an excessive number of policies, things will start breaking**. 
* **DNS is the main supporter of resolution within your Active Directory Domain networks. Make sure DNS is hardened and fault-tolerant. Without DNS, your AD will NOT Work**. 
* **Do not use legacy sharing protocols if possible** (SMB1, NT LanMan). **They are highly vulnerable**. 
    * Legacy file sharing protocols, often in conjunction with many services, are highly vulnerable and should not be used unless absolutely needed. 
    * Example: MS08087 & the Infamous Eternal Blue exploit MS17-010. 
* **Do not expose RDP servers without extra protection or MFA**. They will eventually be compromised. 
    * **RDP servers exposed to the internet are prime targets of malicious actors**, enable and enforce Network Level Authentication mechanism that will discard connection attempts from many Linux RDP hacking tools. 
* Create administrator's accounts to join domain computers to the domain. Then disable them. 
* **Do not use the main administrator account to join new computers**. 
    * Many times, **administrator accounts are used to join new computers to the domain if not expressly done by Group Policies**. If certain legacy sharing protocols are needed, credential information may stay in that computer, which, if compromised, may provide ways to impersonate domain administrators. 
    * Attacks like **Pas the Hash are based on this vulnerability**. 

#### DNS is Important Inside and Outside of the Perimeter

* Domain Name Service is the naming service of the internet 
* Every time you type a xyz.com to reach that address, your system queries a DNS Server 
* As stated previously, **DNS also provides Name Resolution internally via Active Directory and other Directory Services**

#### DNS Security Considerations

* **Isolate DNS servers from outside reach**. **No one outside your organization needs to be querying your DNS Servers**. **This means no access from the internet**. 
* **Keep DNS Server/Software up to date** 
* Restrict Zone Transfers. Zone Transfers: **The ability to perform a request to other servers to replicate their database**. 
    * If an attacker requests a zone transfer from your internal DNS, they may access information from your internal networks. 
* **DNS Cache Poisoning**: A local cache of information being manipulated by attackers. 
* **Disable DNS Recursion**: The **ability to perform queries to different servers if the servers have a bad record like 8.8.8.8 (google), but instead 8.8.8.8 (a bad guy).** 
    * The attacker **may be able to poison your internal cache and bypass access controls directing requests to bad records to download or exfiltrate data**.

Windows: gpedit.msc (group policies editor)

**IPSec policies can be used for?** **Isolate network segments. Prohiubit specific type of traffic. Encrypt communications via IPSecurity.**

You are the security administrator for a huge corporation with many organizational units. You have been commissioned to create a setting that prevents any computer that does not belong to the OUs of Accounting or Management to access the accounting file servers. You have several IP addresses assigned by OUs that you know you can use for segmentation policies. What would be the best way to create this setting?

In this case, it would be good to create an IP Security policy that only allows the hosts from management and accounting to access the accounting file servers. The practical way, and most efficient way, of doing these types of tasks is to use IP Security policies.

### Implement Remote Access Management Policies

Remote Access Management Introduction
    * **Keeping track of who is accessing your perimeter remotely is vital for your security**. 
    * **Remote Access is part of your attack surface**, and as such, it needs to be considered in your Security Infrastructure Assessment. 
    * **There are specific infrastructure elements concerning remote access management that are important in protecting your perimeter from breaching**. 

#### Remote Access Management

A single sign-on SSO like OKTA (https://www.okta.com/), or Ping Identity (https://www.pingidentity.com/en.html). 
A VPN type of access via OpenVPN (https://www.cisco.com/c/en/us/products/security/anyconnect-secure-mobility-client/index.html) or Cisco or Palo Alto Networks (https://www.paloaltonetworks.com/).

We may also have environments where remote access is granted via https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/rds-plan-access-from-anywhere and https://www.ssh.com/academy/ssh

#### Remote Access Considerations

    * **Consider every remote node an extension of your attack surface**. **Every remote node can become potentially hostile**. 
    * **Enforce the use of firewalls and antivirus at remote access points**. These will not take away all threats but will raise the bar and deter low-level skill criminals. 
    * In some cases, **you may need to provide certain users with SOHO UTM devices**. 

#### Unified Threat Management (UTM)

A firewall device that does more than simple static firewall rules. 

What can a UTM provide:
* Packet capture, monitoring, and inspection 
* Antivirus 
* Virtual Private Network 
* Web filtering and monitoring 
* Application monitoring 
* Web Application Firewall 

#### Remote Access Management Best Practices

* Establish an **Acceptable Use Policy for remote access**. 
* **Encryption must be enforced in every connection from outside into the perimeter**. 
* **Implement Multi-Factor Authentication (MFA)**. 
* When possible, **only allow connections from company provisioned devices**.
    * If access from **BYOD devices** must be allowed, **enforce management agents before devices are allowed to connect**. 
* Forbid Shared Access Accounts. Access must be granted on an individual basis. 
* Evaluate the risks of remote access architecture you chose. 
    * For Example, if you chose a web single sign-on portal, you may need to protect that portal with a WAF. 
* Enforce credential management security policies. 
* Enforce network management, monitoring, and principles of least privilege and segregation of duty. 
    * This will allow you to isolate, contain, and deny users that could be compromised. 
* Limit length and duration of sessions. Employees will leave sessions open and expose the company.

### Walk-through Identify Running Remote Access Protocols

Linux: **sudo netstat -tulpan**: this command print out the active connections, including the ports.

Port 513: Rlong runs on it.
Port 5986: WinRM

### IPv6

The newest version of Internet Protocol.
* Just like IPv4 provides identification and location of computers and networks across the internet. 
* Supposed to replace IPv4. 
* Operates at Network Layer (Layer 3).

* **IPv6 allows for a nearly unlimited number of addresses**. 
    * **128-bit addresses can support 1028 times the number of IPv4 addresses**! 
* **No need for Network Address Translation as routing configuration is simpler due to autoconfiguration**. 
    * **You may also not need DHCP**. 
* Simplified network configuration, self-addressed, and neighbor peering. 
* Ability to support multicast communications providing bandwidth efficiency. A multicast is a direct data flow that allows for multiple destinations, simultaneously increasing bandwidth efficiency.

More resources:

https://tools.ietf.org/html/rfc2460
https://datatracker.ietf.org/doc/html/rfc8200

#### Ipv6 Issues

* **Network Address Translation (NAT) has slowed the adoption of IPv6**. 
    * NAT basically allows the translation of private IPv4 Addresses from and to a single Internet assigned an address via router or gateway. 
    * NAT also provides an additional layer of protection when trying to protect the perimeter from internet threats. 
* **Legacy hardware and architecture is still in place that works better with IPv4**. 

#### IPv6 Risks
* Due to address extensions and a large number of addresses, it can be difficult to manage. 
* Runs by default, potentially being missed by monitoring devices and logging settings. This provides a potential access path for attackers. 
* Network security tools running on IPv4 do not necessarily protect IPv6. 
* There are still support issues with ISPs and Vendors. Not all application services and internet providers are fully supporting IPv6. 

**CVE-2020-16898 – Bad Neighbor – Windows TCP/IP issue**

Disable IPv6 linux: In etcdefault/grub set GRUB_CMDLINE_LINUX=”ipv6.disable=1”

#### Walkthrough Identify if IPv6 is Running in Your Network

Windows: netsh interface ipv6 show neighbors
Ping -6 Ipv6-address

Linux, nano /etc/default/ufw IPV6=yes (verifica se o firewall local está cuidando de IPv6)
Windows PowerShell:  netsh advfirewall show currentprofile
Windows: systeminfo

### Protecting Access to Perimeter

#### The Danger of IoTs 


**Every day an uncountable number of devices join the internet**. A lot of these devices are called IoTs or the Internet of Things devices. These might include devices like: coffee makers, refrigerators, crockpots, cameras, wearables, etc.

**Most of these devices are very cheap to acquire and are activated then tend to be forgotten about but are still connected to the internet**. 

**Once these devices are connected, they are a prime target for malicious actors**. **Some of the initial access vectors are hardcoded passwords**. **If you are ever auditing a network perimeter and you find either a camera or even a connected refrigerator, try this**:

* Get the brand and model 
    * Google the brand and model plus password
    * Example: LG LRMVC2306S password 
* Most likely, you will find the default password, and unless the admins changed it and you will have access. This is how most IoTs get accessed. 

**Zombies: Compromised devices that can be used to commit further attacks.**

Once they are accessed, they can be turned into zombies and used for attacks. The biggest current botnets on the internet are composed of thousands of these devices, and the problem is only getting worse. 

Every time you consider buying an IoT device, make sure it is from a reputable brand, that you can upgrade it and patch it, and make sure you have a plan to decommission this device. Remember, if you leave them unattended, you may provide access to malicious actors inside of your perimeter.

#### The WiFi PCI DSS challenge

**One of the tasks I used to perform as a security engineer was to scan the perimeter for Rogue Access Points**. This was part of our **PCI DSS audit and compliance**. **Scanning the perimeter for Rogue Access points is not easy, especially if you are building with other tenants**.

My job was to walk around with a special network card, one that allows packet injection, to run tools that would discover rogue access points. I also needed a GPS antenna to be able to geolocate known and unknown WiFi APs. The procedure included comparing the MAC addresses of what was found to what was supplied to us by the IT Department. That way, if the MAC addresses did not match, we could then investigate further. 

**We used Kismet**. **A popular tool used for scanning WiFi networks**. We had to scan the perimeter constantly and report back to the third party auditors and IT. Today, brands like Cisco Meraki make this job way easier as they have their own protection mechanisms, and you can federate access points. I suggest you consider technologies that would allow you to do this. They may cost more, but they will save you time and money.

**A Rogue Access point or cloned SSID can be an unauthorized entry to your perimeter. These are attack vectors you should always consider if you have access points across your perimeter.**

### Further Readinghttps://docs.microsoft.com/en-us/windows/security/threat-protection/windows-firewall/domain-isolation-policy-design

https://en.wikipedia.org/wiki/VLAN_hopping
https://www.internetsociety.org/deploy360/ipv6/security/faq/
https://owasp.org/www-community/Web_Application_Firewall

Additional Resources

https://www.blackhat.com/presentations/bh-europe-05/BH_EU_05-Berrueta_Andres/BH_EU_05_Berrueta_Andres.pdf

https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-firewall/domain-isolation-policy-design

https://www.microsoft.com/security/blog/2020/04/16/security-guidance-remote-desktop-adoption/

https://openvpn.net/community-resources/how-to/