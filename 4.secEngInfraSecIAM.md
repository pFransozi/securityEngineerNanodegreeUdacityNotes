# Security Engineering Infrastructure Security

## Identity Access Management

### Overview

IAM provides the ability to:
* match right user with the right access
* enforce security policies
* apply principles of least privilege
* apply principles of separation of duties
* verify the identity of access requests

IAM has the following pillars:
* identification: who you are (for instance, username)
* authentication: prove who you are (for instance, password)
* authorization: the process of proving who you are

IAM is the foundation of
* the creation of users
* application of access controls (RBAC, DAC, MAC)
* application of identification, authentication, authorization methods such as SSo, MFA

### Principle of least privilege

PoLP has a basic concept that is a user or process has enough privileges to perform its functions. PoLP demands a perimeter of action for each user, or group, which means proper privileges.

**For instance**: a user can log in and operate a program. However, the user does not have the right to modify or install any program.

**Benefits of Principle of Least Privilege**

* **Restricts users, processes, or applications to only specific privileges**
* Prevents users, processes, and applications **from potentially taking over the operating system** 
* **Attack surface is reduced**, in the case a user or applications are compromised, **damage is limited**

**Best Practices for PoLP**

* Track individual rights 
* **Monitor escalation of privileges**
* **Audit account privilege regularly** 
* Apply to PoLP across users, processes, and applications 

**The main goal is to make sure every entity only has enough privileges to do its job.**

### Segregation of duties

It is a technique that requires with a check-in place more than one person authentication and authorization to complete a task.

For instance:

* a dev commits code and creates a pull request
* a second dev checks code, approves pr, and merges codes
* quality assurance manager tests code in CI/CD platform
* code's new version is released

A priori, just one dev cannot publish a new release independently. So reflect: **why do you think this could be beneficial security-wise?**

**Segregation of Duties Best Practices**

* it need a policy and defined access controls to enforce it.
  * policies must be suitable for your organization
* creating clear workflows for approvals access requests, that are under policies
* monitoring and tracking provisioned privileges. Do not allow accounts to accumulate privileges and cross access boundaries.
* access control such as RBAC can help apply SoD. They are usually implemented via a central authority to provide access depending on a specific role
* use service accounts for specific purposes
  
### service accounts

* Apply PoLP And SoD 
* A non-human account created for a specific service or task 
* Consider service accounts when trying to apply PoLP and SoD.
  
### Access Control Models

* **Mandatory Access Control**
  * access is based on an object and a subject
  * when a subject tries to access an object, security attributes determine the level of access
    * for instance, user wants to access a file, and this user may have only a specific type of access that they cannot change as this comes from a central authority.
* **Discretionary Access Control**
  * access restrictions based on the identity of subjects or groups to which they belong.
  * this access model implies permissions can be inherited or passed to an individual user by others
  * organization groups determine access per group membership. You can see every one in the payroll group has READ permission, but they do not have access to the sales group in the sales group.
* **Role-based Access Control**
  * access based on specific roles
  * can implement MAC or DAC access control models
  * recommended for enterprises with 500 users or more
  * policy neutral. RBAC is designed around roles and privileges

**Three Rules in RBAC**
* a role has to be assigned to a user, and this alone allows him to exercise permissions
* authorization for that role has to be active and defined
* exercise of permission is subjected to authorization from the granted role

**RBAC Considerations**
* permissions can be assigned to many roles and operations
* a single operation can be assigned to many permissions
* roles can have many subjects, and a subject can have many roles
* roles can have many permissions

### Audit Access and Permissions

WIth auditing, we can see how roles, permissions, and operations work with users.
In Linux: auditd (https://linux.die.net/man/8/auditd)
In Windows: audits with GPOs

#### Linux Ubuntu Auditd

* set of rules loaded in the kernel audit system 
* More information: http://manpages.ubuntu.com/manpages/xenial/man8/auditd.8.html 
* Based on Auditd Daemon

Looks for configuration files at:
* /etc/audit/audit.rules 
* /etc/audit/auditd.conf

Auditd - Audit.Rules

* Installation
  * sudo apt install auditd
  * sudo service auditd start
  * sudo service auditd status
  * systemctl is-enabled auditd
* to list current rules
  * sudo auditctl -l
* Audit results are found in
  * /var/log/audit/audit.log
* file system rules
  * w: specifies the directory to watch
  * p: specifies the permissions to be logged
  * k: is for optional strings to identify rules

For instance: watch /etc/sudoers directory and log wa permissions to look for changes in sudoers
* auditctl -w /etc/sudoers -p wa -k change_in_sudoers
* then verify: auditctl -l

* system call rule
  * system call rules are for activities beyond the application level
  * auditctl -a action,list -S syscall -F field=value -k keyname
* control rule
  * audit configuration changes in the auditd system itself
  * sudo auditctl -s

#### Windows Audit Best Practices

https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/audit-policy-recommendations

Computer Configuration -> Windows Settings -> Security Settings -> Advanced Audit Policy Configuration --> System Audit Policies

**Windows Audit: Best Practices**
* Account Logon
  * Audit Credential Validation: Success, Failure
  * Audit Kerberos Authentication Service: Success, Failure
  * Audit Kerberos Service Ticket Operations: Success, Failure
  * Audit Other Account Logon Events: Success, Failure
* Account Management
  * Audit Computer Account Management: Success, Failure
  * Audit Other Account Management Events: Success, Failure
  * Audit Security Group Management: Success, Failure
  * Audit User Account Management: Success, Failure
* Windows Audit, Best Practices
  * Audit Detailed Tracking
  * Audit DPAPI Activity: Success, Failure
  * Audit Process Creation: Success, Failure
* Directory Service Access
  * Audit Directory Service Access 
  * Audit Directory Service Changes
* Audit Logon/Logoff
  * Audit Account Lockout: Success, Failure
  * Audit Login: Success, Failure
  * Audit Logoff: Success, Failure
  * Audit Other Logon/Logoffs Events: Success, Failure
  * Audit Special Logon: Success, Failure 
* Windows Audit, Best Practices Continued (Warning these are very verbose events but may be necessary to be enabled in high-security environments)
  * Audit Detailed File Share Access: Success, Failure
  * Audit File System: Success, Failure 
  * Audit Registry: Success, Failure (A lot of crimeware adds registry keys for persistence after reboot)
  * Audit Removable Storage: Success, Failure (Are employees saving data in unauthorized drives) 
  * Audit SAM: Success, Failure (This one is usually tampered with by ransomware)
* Policy Change
  * Audit Policy Change: Success, Failure
  * Audit Authentication Policy Change: Success, Failure
  * Audit MPSSVC Rule-Level Policy Change: Success, Failure.
    * Microsoft Protection Service service used by windows firewall. Changes to rules, exceptions, settings will be logged on this.
* Privilege Use (Microsoft does not recommend this one. However, I do recommend turning it on, especially for general users)
  * System
    * Audit IPSec Driver: Success, Failure 
    * Audit Security State Change: Success, Failure 
    * Audit Security System Extension: Success, Failure 
    * Audit System Integrity: Success, Failure 


**linux command**
* sudo stat file_name
* sudo chmod 777 file_name

**windows command**
Icacls testfile.txt
Icacls testfile.txt /grant student:R
Icaclcs  testfile.txt /remove student

(https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/icacls)

runas /user:win10-ustudent\administrator cmd.exe  

**Here are some items you need to consider when using icacls.exe**
* D: delete access
* F: full access
* N: no access
* M: modify access
* RX: read and eXecute access
* R: read-only access
* W: write-only access

**Inheritance rights**
* (OI): object inherit
* (CI): container inherit
* (IO): inherit only
* (NP): do not propagate inherit

**specific permissions**
* D: delete
* RC: read control
* WDAC: write DAC
* WO: write owner
* S: synchronize
* AS: access system security
* MA: maximum allowed
* GR: generic read
* GW: generic write
* GE: generic execute
* GA: generic all
* RD: read data/list directory
* WD: write data/add file
* AD: append data/add subdirectory
* REA: read extended attributes
* WEA: write extended attributes
* X: execute/traverse
* DC: delete child
* RA: read attributes
* WA: write attributes